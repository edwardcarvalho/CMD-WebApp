<div id="CadastroCtrl" ng-controller="CadastroCtrl">
    <div class="painel">
        <div class="painel-heading">
            <div class="row">
                <div class="col-xs-12">
                    <span>
                        Cadastro de Medida Disciplinar
                    </span>
                </div>
            </div>
        </div>
        <div class="painel-body">
            <div id="pesquisa">
                <div class="row form-group">
                    <div class="col-xs-12">
                        <div class="col-xs-2">
                            @Html.Label("CPF do Operador", new { @class = "center-label" })
                        </div>
                        <div class="col-xs-2">
                            @Html.TextBox("CpfOperador", null, new { @class = "form-control", ng_model = "cpf", ng_readonly = "funcionario.IdFuncionario" })
                        </div>
                        <div class="col-xs-2">
                            <button class="btn btn-primary" ng-click="buscarDadosFuncionario(cpf)"><span class="fa fa-search"></span></button>
                            <button class="btn btn-danger" ng-click="funcionario='';"><span class="fa fa-eraser"></span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dados">
                <div class="row form-group">
                    <div class="col-xs-12">
                        <div class="col-xs-3">
                            @Html.Label("Filial")
                            @Html.TextBox("Filial", null, new { @class = "form-control", ng_model = "funcionario.Filial.Nome", @readonly = "readonly" })
                        </div>
                        <div class="col-xs-3">
                            @Html.Label("Matricula")
                            @Html.TextBox("Matricula", null, new { @class = "form-control", ng_model = "funcionario.Matricula", @readonly = "readonly" })
                        </div>
                        <div class="col-xs-3">
                            @Html.Label("RG")
                            @Html.TextBox("RG", null, new { @class = "form-control", ng_model = "funcionario.Rg", @readonly = "readonly" })
                        </div>
                        <div class="col-xs-3">
                            @Html.Label("Operação")
                            @Html.TextBox("Operacao", null, new { @class = "form-control", ng_model = "funcionario.Operacao.Nome", @readonly = "readonly" })
                        </div>
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-xs-12">
                        <div class="col-xs-6">
                            @Html.Label("Cargo")
                            @Html.TextBox("Cargo", null, new { @class = "form-control", ng_model = "funcionario.Cargo.Descricao", @readonly = "readonly" })
                        </div>
                        <div class="col-xs-6">
                            @Html.Label("Nome")
                            @Html.TextBox("Nome", null, new { @class = "form-control", ng_model = "funcionario.Nome", @readonly = "readonly" })
                        </div>
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-xs-12">
                        <div class="col-xs-6">
                            @Html.Label("Supervisor")
                            @Html.TextBox("Supervisor", null, new { @class = "form-control", ng_model = "funcionario.Operacao.Supervisor.Nome", @readonly = "readonly" })
                        </div>
                        <div class="col-xs-6">
                            @Html.Label("Gerente")
                            @Html.TextBox("Gerente", null, new { @class = "form-control", ng_model = "funcionario.Operacao.Gerente.Nome", @readonly = "readonly" })
                        </div>
                    </div>
                </div>
                <div id="HistoricoMedidas" ng-show="funcionario.Cpf">
                    <div class="row" style="padding: 25px;">
                        <div class="col-xs-12" style="text-align:center">
                            @Html.Label("Histórico de Medidas do Operador")
                        </div>
                    </div>
                    <div class="row form-group">
                        <div class="col-xs-12">
                            <div class="col-xs-12">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-dark">
                                            <tr>
                                                <!--<th>ID</th>-->
                                                <th>Tipo de Advertência</th>
                                                <th>Motivo</th>
                                                <th>Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="item in funcionario.Medidas">
                                                <!--<td>{{item.IdMedida}}</td>-->
                                                <td>{{item.TipoAdvertenciaDescricao}}</td>
                                                <td>{{item.MotivoDescricao}}</td>
                                                <td>{{item.Quantidade}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="incluir">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="col-xs-12">
                            <button ng-disabled="!funcionario.IdFuncionario" class="btn btn-success pull-right" data-toggle="modal" data-target="#modalIncluir"><i class="fa fa-plus" style="padding-right:5px"></i>Incluir</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* MODAL CONTENT *@

    <div class="modal fade" id="modalIncluir" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document" style="min-width:70%">
            <div class="modal-content">
                <div class="modal-header painel-heading">
                    <h5 class="modal-title" id="exampleModalLabel">Inclusão de Medida Disciplinar</h5>
                </div>
                <div class="modal-body painel-body">
                    <div id="inclusaoMedida">
                        <div class="row form-group">
                            <div class="col-xs-12">
                                <div class="col-xs-6">
                                    @Html.Label("Site")
                                    @Html.DropDownList("Site", (List<SelectListItem>)ViewBag.Filiais, new { @class = "form-control", ng_model = "medida.FilialId" })
                                </div>
                                <div class="col-xs-6">
                                    @Html.Label("Aprovador")
                                    @Html.DropDownList("Aprovador", (List<SelectListItem>)ViewBag.Aprovadores, new { @class = "form-control", ng_model = "medida.FuncAprovadorId" })
                                </div>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-xs-12">
                                <div class="col-xs-6">
                                    @Html.Label("Tipo de Advertencia")
                                    @Html.DropDownList("TipoAdvertencia", (List<SelectListItem>)ViewBag.TiposAdvertencia, new { @class = "form-control", ng_model = "medida.AdvertenciaId" })
                                </div>
                                <div class="col-xs-6">
                                    @Html.Label("Motivo")
                                    @Html.DropDownList("Motivo", (List<SelectListItem>)ViewBag.Motivos, new { @class = "form-control", ng_model = "medida.MotivoId" })
                                </div>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-xs-12">
                                <div class="col-xs-4">
                                    @Html.Label("Data da Ocorrência")
                                    @Html.TextBox("DataOcorrencia", null, new { @class = "form-control", ng_model = "medida.DataOcorrencia" })
                                </div>
                                <div class="col-xs-4">
                                    @Html.Label("Tipo da Ocorrência")
                                    @Html.DropDownList("TipoOcorrencia", (List<SelectListItem>)ViewBag.TipoOcorrencia, new { @class = "form-control", ng_model = "medida.IdTipoOcorrencia" })
                                </div>
                                <div class="col-xs-4">
                                    @Html.Label("Telefone")
                                    @Html.TextBox("Telefone", null, new { @class = "form-control", ng_model = "medida.Telefone", @pattern = "\\([0-9]{2}\\)[\\s][0-9]{4}-[0-9]{4,5}" })
                                </div>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-xs-12">
                                <div class="col-xs-12">
                                    @Html.Label("Descrição")
                                    @Html.TextArea("Descricao", null, new { @class = "form-control", ng_model = "medida.Descricao" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" ng-click="medida =''">Cancelar</button>
                    <button type="button" class="btn btn-primary" ng-click="salvar()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function convertDate(date) {
        var arrDataExclusao = date.split('/');

        var stringFormatada = arrDataExclusao[1] + '-' + arrDataExclusao[0] + '-' +
            arrDataExclusao[2];

        return new Date(stringFormatada);
    }

    $(function () {
        //angular.bootstrap("#CadastroCtrl", ['app']);
        $('#CpfOperador').inputmask("999.999.999-99");
        $('#Telefone').inputmask("(99) 9999-99999");
        $('#DataOcorrencia').datepicker({
            dateFormat: 'dd/mm/yy HH:mm:ss',
            dayNames: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
            dayNamesMin: ['D', 'S', 'T', 'Q', 'Q', 'S', 'S', 'D'],
            dayNamesShort: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
            monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            monthNamesShort: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
            nextText: 'Próximo',
            prevText: 'Anterior'
        });
        $('#DataOcorrencia').inputmask("99/99/9999");
    });
    var app = angular.module("app", []);
    app.controller('CadastroCtrl', ['$scope', '$http', '$timeout', function ($scope, $http, $timeout) {

        $scope.funcionario = {};
        $scope.medida = {};

        $scope.buscarDadosFuncionario = function (cpf) {
            freezeScreen("add");
            $http.get('@Url.Action("GetFuncionarioByCpf", "Medidas")', {
                params: { cpf: cpf },
            }).then(function (response) {
                freezeScreen("remove");
                if(response.data)
                    $scope.funcionario = response.data;
                else
                    swal("CPF não localizado!")

                debugger;
            });
        };

        $scope.salvar = function () {
            debugger;
            freezeScreen("add");
            $scope.medida.FuncionarioId = $scope.funcionario.IdFuncionario;
            $scope.medida.DataOcorrencia = convertDate($scope.medida.DataOcorrencia);
            $http({
                method: 'POST',
                url: '@Url.Action("Salvar","Medidas")',
                params: $scope.medida,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            }).then(function successCallback(response) {
                freezeScreen("remove");
                if (response.data.success) {
                    swal(response.data.message);
                    $timeout(function () {
                        window.location.href = '@Url.Action("Index","Medidas")';
                    }, 1500);
                    } else {
                        swal(response.data.message);
                    }
                });
        }
    }]);

</script>